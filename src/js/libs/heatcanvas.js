var heatcanvasWoker =  new Blob(Array.prototype.map.call(document.querySelectorAll("script[type=\"text\/js-worker\"]"), function (oScript) { return oScript.textContent; }),{type: "text/javascript"});

var HeatCanvas=function(a){if(typeof(a)=="string"){this.canvas=document.getElementById(a)}else{this.canvas=a}if(this.canvas==null){return null}this.worker=new Worker(window.URL.createObjectURL(heatcanvasWoker));this.width=this.canvas.width;this.height=this.canvas.height;this.onRenderingStart=null;this.onRenderingEnd=null;this.data={}};HeatCanvas.prototype.resize=function(a,b){this.width=this.canvas.width=a;this.height=this.canvas.height=b;this.canvas.style.width=a+"px";this.canvas.style.height=b+"px"};HeatCanvas.prototype.push=function(a,d,b){if(a<0||a>this.width){return}if(d<0||d>this.height){return}var c=a+d*this.width;if(this.data[c]){this.data[c]=this.data[c]+b}else{this.data[c]=b}};HeatCanvas.prototype.render=function(b,c,e){b=b||1;c=c||HeatCanvas.LINEAR;var a=this;this.worker.onmessage=function(f){a.value=f.data.value;a.data={};a._render(e);if(a.onRenderingEnd){a.onRenderingEnd()}};var d={data:a.data,width:a.width,height:a.height,step:b,degree:c,value:a.value};this.worker.postMessage(d);if(this.onRenderingStart){this.onRenderingStart()}};HeatCanvas.prototype._render=function(b){b=b||HeatCanvas.defaultValue2Color;var l=this.canvas.getContext("2d");l.clearRect(0,0,this.width,this.height);defaultColor=this.bgcolor||[0,0,0,255];var d=l.createImageData(this.width,this.height);for(var e=0;e<d.data.length;e+=4){d.data[e]=defaultColor[0];d.data[e+1]=defaultColor[1];d.data[e+2]=defaultColor[2];d.data[e+3]=defaultColor[3]}var f=0;for(var a in this.value){f=Math.max(this.value[a],f)}for(var j in this.value){var k=Math.floor(j%this.width);var h=Math.floor(j/this.width);var g=h*this.width*4+k*4;var c=HeatCanvas.hsla2rgba.apply(null,b(this.value[j]/f));d.data[g]=c[0];d.data[g+1]=c[1];d.data[g+2]=c[2];d.data[g+3]=c[3]}l.putImageData(d,0,0)};HeatCanvas.prototype.clear=function(){this.data={};this.value={};this.canvas.getContext("2d").clearRect(0,0,this.width,this.height)};HeatCanvas.prototype.exportImage=function(){return this.canvas.toDataURL()};HeatCanvas.defaultValue2Color=function(f){var e=(1-f);var c=f*0.6;var d=0.8;var b=1;return[e,d,c,b]};HeatCanvas.hsla2rgba=function(j,o,i,n){var c,k,m;if(o==0){c=k=m=i}else{function f(g,b,a){if(a<0){a+=1}if(a>1){a-=1}if(a<1/6){return g+(b-g)*6*a}if(a<1/2){return b}if(a<2/3){return g+(b-g)*(2/3-a)*6}return g}var d=i<0.5?i*(1+o):i+o-i*o;var e=2*i-d;c=f(e,d,j+1/3);k=f(e,d,j);m=f(e,d,j-1/3)}return[c*255,k*255,m*255,n*255]};HeatCanvas.LINEAR=1;HeatCanvas.QUAD=2;HeatCanvas.CUBIC=3;HeatCanvas.getPath=function(){var c=document.getElementsByTagName("script");for(var b=0;b<c.length;b++){var d=c[b].src;var a=d.match(/heatcanvas(-[a-z0-9]{32})?\.js/);var e=a?a.index:0;if(e>0){return d.substring(0,e)}}return""};L.TileLayer.HeatCanvas=L.Class.extend({initialize:function(a,b){this.heatCanvasOptions=b;this.data=[];this._onRenderingStart=null;this._onRenderingEnd=null},onRenderingStart:function(a){this._onRenderingStart=a},onRenderingEnd:function(a){this._onRenderingEnd=a},onAdd:function(a){this.map=a;this._initHeatCanvas(this.map,this.heatCanvasOptions);a.on("moveend",this._redraw,this);this._redraw()},onRemove:function(a){a.getPanes().overlayPane.removeChild(this._div);a.off("moveend",this._redraw,this)},_initHeatCanvas:function(c,b){b=b||{};this._step=b.step||1;this._degree=b.degree||HeatCanvas.LINEAR;this._opacity=b.opacity||0.6;this._colorscheme=b.colorscheme||null;var a=L.DomUtil.create("div","leaflet-heatmap-container");a.style.position="absolute";a.style.width=this.map.getSize().x+"px";a.style.height=this.map.getSize().y+"px";var d=document.createElement("canvas");d.width=this.map.getSize().x;d.height=this.map.getSize().y;d.style.width=d.width+"px";d.style.height=d.height+"px";d.style.opacity=this._opacity;a.appendChild(d);this.heatmap=new HeatCanvas(d);this.heatmap.onRenderingStart=this._onRenderingStart;this.heatmap.onRenderingEnd=this._onRenderingEnd;this._div=a;this.map.getPanes().overlayPane.appendChild(this._div)},pushData:function(b,c,a){this.data.push({lat:b,lon:c,v:a})},_resetCanvasPosition:function(){var b=this.map.getBounds();var a=this.map.latLngToLayerPoint(b.getNorthWest());L.DomUtil.setPosition(this._div,a)},_redraw:function(){this._resetCanvasPosition();this.heatmap.clear();if(this.data.length>0){for(var c=0,b=this.data.length;c<b;c++){var d=new L.LatLng(this.data[c].lat,this.data[c].lon);var a=this.map.latLngToLayerPoint(d);a=this.map.layerPointToContainerPoint(a);this.heatmap.push(Math.floor(a.x),Math.floor(a.y),this.data[c].v)}this.heatmap.render(this._step,this._degree,this._colorscheme)}return this},clear:function(){this.heatmap.clear();this.data=[]},redraw:function(){this._redraw()}});L.TileLayer.heatcanvas=function(a){return new L.TileLayer.HeatCanvas(a)};
